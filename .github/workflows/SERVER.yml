# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: SERVER
'on':
  push:
    branches:
      - main
      - feature/**
    paths:
      - server/**
      - .github/workflows/SERVER.yml
jobs:
  BUILD_AND_DEPLOY_DEV:
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: CHECKOUT 
        uses: actions/checkout@v2
      - name: USE NODE.JS 
        uses: actions/setup-node@v3
        with:
          node-version: 14.x
      - name: SET UP PYTHON 
        uses: actions/setup-python@v3
        with:
          python-version: 3.10.4
      - name: INSTALL PYTHON DEPENDENCIES
        run: |
          cd server/functions/scripts
          pip install -r packages
      - name: INSTALL NODE DEPENDENCIES
        run: |
          cd server/functions
          npm i
          npm i -g firebase-tools@11.0.1 
      - name: BUILD ENTITIES
        run: |
          cd entities
          npm run build:pipeline
      # - name: RUN TEST
      #   run: |
      #     cd server/functions
      #     npm test
      # - name: VALIDATE CONDITIONS OF GOOD SOFTWARE
      #   run: |
      #     cd server/functions/scripts
      #     python3 validate-coverage.py --path ../coverage/lcov-report/index.html
      - name: DEPLOY DEV
        run: |
          cd server
          firebase use dev --token "${{secrets.FIREBASE_TOKEN}}"
          firebase deploy --token "${{secrets.FIREBASE_TOKEN}}" --force



  BUILD_AND_DEPLOY_PDN:
    needs: [BUILD_AND_DEPLOY_DEV]
    runs-on: ubuntu-latest
    environment: pdn
    steps:
      - name: CHECKOUT 
        uses: actions/checkout@v2
      - name: USE NODE.JS 
        uses: actions/setup-node@v3
        with:
          node-version: 14.x
      - name: SET UP PYTHON 
        uses: actions/setup-python@v3
        with:
          python-version: 3.10.4
      - name: INSTALL PYTHON DEPENDENCIES
        run: |
          cd server/functions/scripts
          pip install -r packages
      - name: INSTALL NODE DEPENDENCIES
        run: |
          cd server/functions
          npm i
          npm i -g firebase-tools@11.0.1 
      - name: BUILD ENTITIES
        run: |
          cd entities
          npm run build:pipeline
      # - name: RUN TEST
      #   run: |
      #     cd server/functions
      #     npm test
      # - name: VALIDATE CONDITIONS OF GOOD SOFTWARE
      #   run: |
      #     cd server/functions/scripts
      #     python3 validate-coverage.py --path ../coverage/lcov-report/index.html
      - name: DEPLOY PDN
        run: |
          cd server
          echo "${{secrets.FIREBASE_ENV_CONFIG}}" > functions/src/env.ts
          cat functions/src/env.ts
          firebase use pdn --token "${{secrets.FIREBASE_TOKEN}}"
          firebase deploy --token "${{secrets.FIREBASE_TOKEN}}" --force



